function copy(t){return Object.assign({},t)}import{TAU}from"./math.js";import{Complex}from"./complex.js";import{FourierCoefs}from"./fourier.js";import{SVG}from"./svg_api.js";class FourierSketch{constructor(t,e,i=null,s=1,h=1){this.canvas=new SVG(e),this.path=this.canvas.createElement("polyline",{id:"path"}),this.vectors=this.canvas.createElement("g",{id:"vectors"}),this.epicycles=this.canvas.createElement("g",{id:"epicycles"}),this.cycle=[],this.vector=[],this.preprocess(t,h),this.length=this._f.length,i||(i=this.length),this.coefs=FourierCoefs(this._f,i),this.coefs.sort((t,e)=>e.r-t.r),this.initDrawing(),this.nbCoefs=Math.floor(this.coefs.length),this.current_frame=0,this.time_interval=1e3*s/this.length}set nbCoefs(t){this.nb_coefs=t>this.coefs.length?this.coefs.length:t;let e=Math.floor(t/2);this.index=this.generate_index(-e,this.nb_coefs-e),this.partialSeries()}generate_index(t,e){let i=new Array;for(let s=0;s<this.coefs.length;s++)this.coefs[s].index>=t&&this.coefs[s].index<e?(i.push(s),this.cycle[s].setAttribute("visibility","visible"),this.vector[s].setAttribute("visibility","visible")):(this.cycle[s].setAttribute("visibility","hidden"),this.vector[s].setAttribute("visibility","hidden"));return i}preprocess(t,e){this._f=[];let i={min:Infinity,max:-Infinity},s={min:Infinity,max:-Infinity};for(let h=0;h<t.length;h+=e){const e=t[h].x,r=t[h].y,n=new Complex(e,r);this._f.push(n),i.min=e<i.min?e:i.min,i.max=e>i.max?e:i.max,s.min=r<s.min?r:s.min,s.max=r>s.max?r:s.max}let h={width:i.max-i.min,height:s.max-s.min},r={x:(i.min+i.max)/2,y:(s.min+s.max)/2};for(let t=0;t<this._f.length;t++)this._f[t].re-=r.x,this._f[t].im-=r.y;let n=(h.width+h.height)/4,a=[-h.width/2-n,-h.height/2-n,h.width+2*n,h.height+2*n];this.canvas.width="100%",this.canvas.height="100%",this.canvas.viewBox=a.join(" ")}partialSeries(){this.partial=new Array(this.length);for(let t=0;t<this.length;t++){let e=0,i=0;this.partial[t]=new Array(this.nb_coefs);for(let s=0;s<this.nb_coefs;s++){let h=copy(this.coefs[this.index[s]]),r=h.arg+h.index*TAU*t/this.length;e+=h.r*Math.cos(r),i+=h.r*Math.sin(r),this.partial[t][s]=copy({x:e,y:i})}}}initDrawing(){this.epicycles.setAttribute("fill","none"),this.epicycles.setAttribute("stroke","black"),this.epicycles.setAttribute("stroke-width",".3"),this.vectors.setAttribute("fill","none"),this.vectors.setAttribute("stroke","grey"),this.vectors.setAttribute("stroke-width",".3"),this.path.setAttribute("fill","none"),this.path.setAttribute("stroke","black");for(let t=0;t<this.coefs.length;t++)this.cycle.push(this.epicycles.createElement("circle",{id:this.coefs.index})),this.vector.push(this.vectors.createElement("line"))}drawFrame(t){let e={x:0,y:0};this.index.forEach(i=>{this.cycle[i].center=copy(e),this.cycle[i].radius=this.coefs[i].r,this.vector[i].start=copy(e),this.vector[i].end=copy(this.partial[t][i]),e=copy(this.partial[t][i])}),this.path.length>=this.length&&this.path.pop(),this.path.push(e)}animate(){this._play=!0,setInterval(()=>{this._play&&(this.drawFrame(this.current_frame++),this.current_frame>=this.length&&(this.current_frame=0))},this.time_interval),this.canvas.parent.addEventListener("click",()=>{this._play=!this._play})}play(){this._play=!0}pause(){this._play=!1}controlSlider(t){var e=document.getElementById(t);e.setAttribute("max",this.coefs.length),e.setAttribute("value",this.nb_coefs),e.addEventListener("change",t=>{this.nbCoefs=t.target.value})}}export{FourierSketch};